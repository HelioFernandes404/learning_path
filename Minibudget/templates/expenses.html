{% extends 'layouts/base.html' %} {% import 'components/forms.html' as forms %}
{% import 'components/icons.html' as icons %} {% block content %}

<!-- Header Section with Action Context -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-xl font-bold tracking-tight">Despesas</h2>
        <p class="text-sm text-muted">Gerencie seus lançamentos e histórico.</p>
    </div>

    {% if edit_expense %}
    <a href="{{ url_for('expenses') }}" class="btn btn-outline btn-sm">
        {{ icons.icon('x', class='mr-2') }} Cancelar Edição
    </a>
    {% endif %}
</div>

<div class="grid grid-sidebar gap-8 items-start">
    <!-- LEFT: Sticky Action Panel (Form) -->
    <div class="sticky top-24">
        <div
            class="card shadow-md border-{% if edit_expense %}primary{% else %}border{% endif %} transition-colors"
        >
            <div
                class="card-header border-b border-border py-3 px-4 bg-secondary/30"
            >
                <h3 class="font-semibold text-sm flex items-center gap-2">
                    {% if edit_expense %} {{ icons.icon('pencil-simple',
                    class='text-primary') }} Editando #{{ edit_expense.id }} {%
                    else %} {{ icons.icon('plus-circle', class='text-primary')
                    }} Novo Lançamento {% endif %}
                </h3>
            </div>

            <div class="card-content p-4">
                <form
                    action="{{ url_for('expenses') }}"
                    method="POST"
                    class="grid gap-4"
                >
                    {% if edit_expense %}
                    <input
                        type="hidden"
                        name="expense_id"
                        value="{{ edit_expense.id }}"
                    />
                    {% endif %}

                    <!-- Amount Highlight -->
                    <div class="space-y-1">
                        <label
                            class="text-xs font-medium text-muted-foreground uppercase tracking-wide"
                            >Valor (R$)</label
                        >
                        <div class="relative">
                            <span
                                class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground font-semibold"
                                >R$</span
                            >
                            <input
                                type="number"
                                step="0.01"
                                name="amount"
                                class="input pl-9 text-lg font-bold tabular-nums"
                                placeholder="0,00"
                                required
                                value="{{ edit_expense.amount if edit_expense else '' }}"
                                autofocus
                            />
                        </div>
                    </div>

                    {{ forms.input('description', 'Descrição',
                    value=edit_expense.description if edit_expense else '',
                    placeholder='Ex: Supermercado Semanal', required=True,
                    class='text-sm') }} {{ forms.input('expense_date', 'Data',
                    type='date', value=edit_expense.expense_date if edit_expense
                    else today, required=True, class='text-sm') }}

                    <div class="grid grid-cols-2 gap-3">
                        {{ forms.select('category', 'Categoria', categories,
                        selected=edit_expense.category if edit_expense else
                        None, required=True, class='text-sm') }} {{
                        forms.select('payment_type', 'Pagamento', payment_types,
                        selected=edit_expense.payment_type if edit_expense else
                        None, required=True, class='text-sm') }}
                    </div>

                    <button
                        type="submit"
                        class="btn {% if edit_expense %}btn-primary{% else %}btn-primary{% endif %} w-full mt-2 h-10 shadow-sm font-semibold"
                    >
                        {% if edit_expense %} {{ icons.icon('check',
                        class='mr-2') }} Atualizar Lançamento {% else %} {{
                        icons.icon('plus', class='mr-2') }} Adicionar Despesa {%
                        endif %}
                    </button>
                </form>
            </div>
        </div>

        <!-- Helper Tip -->
        {% if not edit_expense %}
        <div class="mt-4 px-4 text-xs text-muted text-center leading-relaxed">
            <p>
                Dica: Use <strong>TAB</strong> para navegar entre os campos
                rapidamente.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- RIGHT: History Data Table -->
    <div class="card shadow-sm min-h-[600px] flex flex-col">
        <div
            class="card-header border-b border-border py-3 px-4 flex-row justify-between items-center bg-secondary/10"
        >
            <div class="flex items-center gap-2">
                <h3 class="font-semibold text-sm">Histórico Completo</h3>
                <span class="badge badge-secondary text-[10px]"
                    >{{ expenses|length }}</span
                >
            </div>

            <!-- Future Filter Placeholder -->
            <div class="flex gap-2">
                <button
                    class="btn btn-ghost btn-sm btn-icon text-muted hover:text-foreground"
                    title="Filtrar (Em breve)"
                    disabled
                >
                    {{ icons.icon('funnel') }}
                </button>
                <button
                    class="btn btn-ghost btn-sm btn-icon text-muted hover:text-foreground"
                    title="Exportar (Em breve)"
                    disabled
                >
                    {{ icons.icon('download-simple') }}
                </button>
            </div>
        </div>

        <div class="table-container flex-1">
            <table class="table table-compact w-full">
                <thead
                    class="bg-secondary/20 sticky top-0 z-10 backdrop-blur-sm"
                >
                    <tr>
                        <th class="w-[120px]">Data</th>
                        <th>Descrição</th>
                        <th class="w-[140px]">Categoria</th>
                        <th class="text-right w-[140px]">Valor</th>
                        <th class="w-[100px] text-center">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border">
                    {% for expense in expenses %}
                    <tr
                        class="group hover:bg-muted/40 transition-colors {% if edit_expense and edit_expense.id == expense.id %}bg-muted border-l-2 border-primary{% endif %}"
                    >
                        <td
                            class="text-muted-foreground font-medium text-xs font-variant-numeric tabular-nums"
                        >
                            {{ expense.expense_date | date_br }}
                        </td>
                        <td>
                            <div class="font-medium text-sm text-foreground/90">
                                {{ expense.description }}
                            </div>
                            <div
                                class="text-[10px] text-muted uppercase tracking-wider group-hover:text-muted-foreground transition-colors"
                            >
                                {{ expense.payment_type }}
                            </div>
                        </td>
                        <td>
                            <span
                                class="badge badge-outline text-[10px] font-medium text-muted-foreground bg-background"
                            >
                                {{ expense.category }}
                            </span>
                        </td>
                        <td
                            class="text-right font-bold text-sm font-variant-numeric tabular-nums text-foreground/90"
                        >
                            {{ expense.amount | currency }}
                        </td>
                        <td class="text-center whitespace-nowrap">
                            <div
                                class="flex items-center justify-center gap-1 transition-opacity"
                            >
                                <a
                                    href="{{ url_for('expenses', edit=expense.id) }}"
                                    class="btn btn-ghost btn-sm btn-icon h-7 w-7 text-primary/70 hover:text-primary hover:bg-primary/10 transition-colors"
                                    title="Editar"
                                >
                                    {{ icons.icon('pencil-simple', class='w-4
                                    h-4') }}
                                </a>

                                <form
                                    action="{{ url_for('delete_expense', id=expense.id) }}"
                                    method="POST"
                                    onsubmit="return confirm('Excluir esta despesa permanentemente?');"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-ghost btn-sm btn-icon h-7 w-7 text-destructive/70 hover:text-destructive hover:bg-destructive/10"
                                        title="Excluir"
                                    >
                                        {{ icons.icon('trash', class='w-4 h-4')
                                        }}
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center p-16 text-muted">
                            <div class="flex flex-col items-center gap-3">
                                <div
                                    class="w-12 h-12 rounded-full bg-secondary flex items-center justify-center text-muted-foreground"
                                >
                                    {{ icons.icon('receipt', class='w-6 h-6') }}
                                </div>
                                <p class="text-sm">
                                    Nenhum lançamento encontrado.
                                </p>
                                <p class="text-xs text-muted-foreground">
                                    Adicione sua primeira despesa ao lado.
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
