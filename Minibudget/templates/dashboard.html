{% extends 'layouts/base.html' %}
{% import 'components/cards.html' as cards %}
{% import 'components/icons.html' as icons %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
        <h2 class="text-xl font-bold tracking-tight">Visão Geral</h2>
        <!-- Month Navigator (Compact) -->
        <div class="flex items-center bg-secondary/50 rounded-md border border-border p-0.5">
            <a href="{{ url_for('dashboard', month=prev_month) }}" class="btn btn-ghost btn-sm btn-icon h-7 w-7" title="Mês Anterior">
                {{ icons.icon('caret-left', class='w-4 h-4') }}
            </a>
            <span class="text-sm font-medium text-foreground min-w-[100px] text-center capitalize px-2">
                {{ current_date | month_br }}
            </span>
            <a href="{{ url_for('dashboard', month=next_month) }}" class="btn btn-ghost btn-sm btn-icon h-7 w-7" title="Próximo Mês">
                {{ icons.icon('caret-right', class='w-4 h-4') }}
            </a>
        </div>
        {% if current_date.strftime('%Y-%m') != now().strftime('%Y-%m') %}
        <a href="{{ url_for('dashboard') }}" class="text-xs font-medium text-primary hover:underline">
            Voltar para hoje
        </a>
        {% endif %}
    </div>

    <div class="flex items-center gap-2">
         <a href="{{ url_for('settings') }}" class="btn btn-outline btn-sm">
            {{ icons.icon('gear', class='mr-2') }} Orçamento
        </a>
        <a href="{{ url_for('expenses') }}" class="btn btn-primary btn-sm shadow-sm">
            {{ icons.icon('plus', class='mr-2') }} Despesa
        </a>
    </div>
</div>

<!-- HERO SECTION: Consolidated Financial Health -->
<div class="card mb-8 shadow-md border-none bg-gradient-to-br from-card to-secondary/30">
    <div class="card-content p-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-center">
            
            <!-- Main Stat: Remaining -->
            <div class="lg:col-span-4 space-y-3">
                <div class="flex items-center gap-2 text-muted-foreground">
                    {{ icons.icon('wallet', class='w-4 h-4') }}
                    <p class="text-[10px] font-bold uppercase tracking-widest">Saldo Disponível</p>
                </div>
                <div class="stat-hero-value text-5xl tracking-tighter {% if remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ remaining | currency }}
                </div>
                <div class="flex items-center gap-4 pt-2">
                    <div class="px-3 py-1 bg-secondary rounded-full border border-border">
                        <span class="text-[10px] text-muted-foreground uppercase font-bold mr-1">Meta</span>
                        <span class="text-xs font-bold">{{ budget | currency }}</span>
                    </div>
                    <div class="px-3 py-1 bg-secondary rounded-full border border-border">
                        <span class="text-[10px] text-muted-foreground uppercase font-bold mr-1">Gasto</span>
                        <span class="text-xs font-bold">{{ total_spent | currency }}</span>
                    </div>
                </div>
            </div>

            <!-- Divider (Desktop) -->
            <div class="hidden lg:block lg:col-span-1 place-self-center">
                <div class="w-px h-24 bg-border/60"></div>
            </div>

            <!-- Insights Grid -->
            <div class="lg:col-span-7">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-8">
                    <!-- 1. Vs Previous -->
                    <div class="space-y-2">
                        <p class="text-[10px] text-muted-foreground uppercase font-bold tracking-widest">Performance</p>
                        <div class="flex items-center gap-2">
                            <div class="p-2 rounded-lg {{ 'bg-danger/10 text-danger' if delta_prev_val > 0 else 'bg-success/10 text-success' }}">
                                {{ icons.icon('arrow-up' if delta_prev_val > 0 else 'arrow-down', class='w-5 h-5') }}
                            </div>
                            <div>
                                <div class="text-lg font-extrabold leading-none">
                                    {% if delta_prev_val > 0 %}+{% endif %}{{ delta_prev_val | currency }}
                                </div>
                                <p class="text-[10px] font-medium text-muted-foreground mt-1">vs. mês anterior</p>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Trend -->
                    <div class="space-y-2">
                        <p class="text-[10px] text-muted-foreground uppercase font-bold tracking-widest">Tendência</p>
                        <div class="flex items-center gap-2">
                            <div class="p-2 rounded-lg bg-primary/5 text-primary">
                                {{ icons.icon('chart-line-up' if trend == 'up' else ('chart-line-down' if trend == 'down' else 'minus'), class='w-5 h-5') }}
                            </div>
                            <div>
                                <div class="text-sm font-extrabold capitalize leading-none">
                                    {% if trend == 'up' %}Acelerando{% elif trend == 'down' %}Economizando{% else %}Estável{% endif %}
                                </div>
                                <p class="text-[10px] font-medium text-muted-foreground mt-1">ritmo atual</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Budget Usage -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <p class="text-[10px] text-muted-foreground uppercase font-bold tracking-widest">Uso da Meta</p>
                            <span class="text-xs font-black">{{ percentage | round(0) }}%</span>
                        </div>
                        <div class="progress-bg h-2.5 bg-secondary/50 overflow-hidden rounded-full border border-border/40">
                            <div class="progress-fill {% if remaining < 0 %}danger{% else %}success{% endif %} transition-all duration-700 ease-in-out" style="width: {{ [percentage, 100] | min }}%"></div>
                        </div>
                        <p class="text-[10px] font-medium text-muted-foreground text-right italic">
                            {% if percentage < 50 %}Dentro do esperado{% elif percentage < 90 %}Atenção redobrada{% else %}Limite crítico{% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ASYMMETRIC GRID: History (Primary) + Breakdown (Secondary) -->
<div class="grid grid-dashboard gap-6 items-start">
    
    <!-- LEFT: Recent Transactions (Wider) -->
    <div class="card shadow-sm overflow-hidden">
        <div class="card-header flex-row items-center justify-between py-3 px-4 border-b border-border bg-secondary/20">
            <h3 class="font-semibold text-sm">Últimas Transações</h3>
            <a href="{{ url_for('expenses') }}" class="text-xs font-medium text-primary hover:underline">Ver todas &rarr;</a>
        </div>
        <div class="table-container">
            <table class="table table-compact w-full">
                <tbody>
                    {% for expense in expenses %}
                    <tr class="group">
                        <td class="w-[120px] text-muted font-variant-numeric tabular-nums text-xs">
                            {{ expense.expense_date | date_br }}
                        </td>
                        <td class="max-w-[200px]">
                            <div class="font-medium text-sm truncate text-foreground/90 group-hover:text-foreground">
                                {{ expense.description }}
                            </div>
                        </td>
                        <td class="w-[1px] whitespace-nowrap">
                            <span class="badge badge-secondary text-[10px] uppercase tracking-wide font-semibold text-muted-foreground">
                                {{ expense.category }}
                            </span>
                        </td>
                        <td class="text-right font-medium text-sm font-variant-numeric tabular-nums w-[120px]">
                            {{ expense.amount | currency }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-12 text-muted text-sm">
                            Nenhuma movimentação neste mês.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- RIGHT: Category Breakdown (Narrower) -->
    <div class="card shadow-sm h-full">
        <div class="card-header border-b border-border py-3 px-4 bg-secondary/20">
            <h3 class="font-semibold text-sm">Por Categoria</h3>
        </div>
        <div class="card-content p-4 flex flex-col gap-3">
            {% for category, amount in category_stats.items() %}
            <div class="group">
                <div class="flex items-center justify-between text-xs mb-1.5">
                    <span class="font-medium text-foreground/80 group-hover:text-foreground">{{ category }}</span>
                    <span class="font-variant-numeric tabular-nums font-semibold">{{ amount | currency }}</span>
                </div>
                <div class="progress-bg h-1.5 bg-secondary">
                    <div class="progress-fill bg-foreground/80 group-hover:bg-foreground transition-all" style="width: {{ (amount / total_spent * 100) if total_spent > 0 else 0 }}%"></div>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted text-sm py-8">Sem dados.</div>
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}